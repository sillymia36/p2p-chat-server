<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Minimal P2P Chat</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    #chat { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 1rem; }
    #msg { width: 80%; }
    button { width: 18%; }
  </style>
</head>
<body>
  <h2>Minimal P2P Chat</h2>
  <div id="chat"></div>
  <input id="msg" placeholder="Type message..." />
  <button id="send">Send</button>

  <script>
    const chat = document.getElementById('chat');
    const msgInput = document.getElementById('msg');
    const sendBtn = document.getElementById('send');

    // <-- You will replace this URL with your deployed signaling server URL later -->
    const signalingServer = 'ws://localhost:3000'; 
    const ws = new WebSocket(signalingServer);

    let pc;
    let dataChannel;

    ws.onopen = () => {
      log('Connected to signaling server');
      start();
    };

    ws.onmessage = async (event) => {
      const data = JSON.parse(event.data);

      if (data.offer) {
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ answer }));
      } else if (data.answer) {
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      } else if (data.candidate) {
        try {
          await pc.addIceCandidate(data.candidate);
        } catch (e) {
          console.error('Error adding ICE candidate:', e);
        }
      }
    };

    function log(msg) {
      chat.innerHTML += `<div>${msg}</div>`;
      chat.scrollTop = chat.scrollHeight;
    }

    function start() {
      pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],
      });

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({ candidate: event.candidate }));
        }
      };

      dataChannel = pc.createDataChannel('chat');

      dataChannel.onopen = () => log('Data channel opened. You can chat now.');
      dataChannel.onmessage = (event) => log(`Peer: ${event.data}`);

      pc.ondatachannel = (event) => {
        dataChannel = event.channel;
        dataChannel.onopen = () => log('Data channel opened. You can chat now.');
        dataChannel.onmessage = (event) => log(`Peer: ${event.data}`);
      };

      pc.createOffer().then((offer) => {
        pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ offer }));
      });
    }

    sendBtn.onclick = () => {
      const message = msgInput.value;
      if (message && dataChannel && dataChannel.readyState === 'open') {
        dataChannel.send(message);
        log(`You: ${message}`);
        msgInput.value = '';
      }
    };
  </script>
</body>
</html>

